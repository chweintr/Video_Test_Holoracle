<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Indiana - Hologram Display</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <div id="click-to-start" class="click-to-start">
        <div class="start-prompt">Touch to Begin</div>
    </div>

    <div id="stage">
        <div id="layer-bottom-floaties" class="video-layer-container" data-layer="1">
            <video id="video-bottom-floaties" class="video-layer floaties" playsinline loop muted></video>
        </div>
        <div id="layer-abstract" class="video-layer-container" data-layer="2">
            <div id="head-container-video" class="head-container">
                <video id="video-idle-loop" class="video-layer head-video" playsinline loop muted></video>
                <video id="video-transition" class="video-layer head-video" playsinline muted></video>
            </div>
        </div>
        <div id="layer-simli" class="video-layer-container" data-layer="3">
            <div id="head-container-simli" class="head-container">
                <div id="simli-mount" class="simli-wrapper"></div>
            </div>
        </div>
        <div id="layer-top-floaties" class="video-layer-container" data-layer="4">
            <video id="video-top-floaties" class="video-layer floaties" playsinline loop muted></video>
        </div>
        <div id="status-overlay" class="status-overlay hidden">
            <div class="status-message"></div>
        </div>
        <div id="border-mask" class="border-mask"></div>
    </div>

    <div id="debug-panel" class="debug-panel hidden">
        <div>State: <span id="debug-state">idle</span></div>
        <div>Persona: <span id="debug-persona">none</span></div>
        <div>Simli: <span id="debug-simli">-</span></div>
    </div>

    <div id="control-panel" class="control-panel">
        <button id="btn-mabel" class="ctrl-btn">Summon Mabel</button>
        <button id="btn-dismiss" class="ctrl-btn ctrl-dismiss">Dismiss</button>
    </div>

    <script src="config.js"></script>
    <script src="state-machine.js"></script>
    <script src="simli-integration.js"></script>
    <script src="compositor.js"></script>
    
    <script>
        let isStarted = false;
        const params = new URLSearchParams(window.location.search);
        
        document.getElementById('click-to-start').addEventListener('click', () => {
            if (isStarted) return;
            isStarted = true;
            document.getElementById('click-to-start').classList.add('hidden');
            if (typeof Compositor !== 'undefined') Compositor.startIdleLoop();
            const persona = params.get('persona');
            if (persona && CONFIG.personas && CONFIG.personas[persona]) {
                setTimeout(() => Compositor.invokePersona(persona), 500);
            }
        });
        
        document.getElementById('btn-mabel').addEventListener('click', () => {
            if (!isStarted) document.getElementById('click-to-start').click();
            setTimeout(() => Compositor.invokePersona('mabel'), 100);
        });
        
        document.getElementById('btn-dismiss').addEventListener('click', () => {
            Compositor.dismissPersona();
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            if (params.get('debug') === 'true') document.getElementById('debug-panel').classList.remove('hidden');
            if (params.get('hidecontrols') === 'true') document.getElementById('control-panel').style.display = 'none';
            if (params.get('autostart') === 'true') document.getElementById('click-to-start').click();
        });
        
        window.addEventListener('message', (event) => {
            const { action, persona } = event.data || {};
            if (action === 'start') document.getElementById('click-to-start').click();
            if (action === 'invoke' && persona) {
                if (!isStarted) document.getElementById('click-to-start').click();
                setTimeout(() => Compositor.invokePersona(persona), 100);
            }
            if (action === 'dismiss') Compositor.dismissPersona();
            if (action === 'reset') Compositor.forceReset();
        });
    </script>
</body>
</html>
