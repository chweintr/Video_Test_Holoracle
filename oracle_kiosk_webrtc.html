<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Echoes of Indiana â€” WebRTC Compose</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Michroma&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --cyan:#4de3ff; --magenta:#ff4df3; --violet:#7e6bff;
  --mx:50%; --my:50%;
  --title-font:'Michroma', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --ui-font:'Rajdhani', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
html, body { height:100%; }
body{
  margin:0; padding:0; overflow:hidden; color:#e7faff;
  font-family:var(--ui-font);
  background:#000 url('/assets/landing-foreground.png') center center / cover no-repeat fixed;
}
h1{
  font-family:var(--title-font);
  text-shadow:0 0 8px var(--cyan), 0 0 20px var(--cyan), 0 0 38px var(--violet);
  font-weight:700; letter-spacing:0.08em; text-transform:uppercase;
}
.subtitle{
  font-family:var(--title-font);
  text-transform:uppercase; letter-spacing:0.14em;
  color:var(--magenta);
  text-shadow:0 0 8px var(--magenta), 0 0 22px var(--magenta);
}
.btn{
  font-family:var(--ui-font);
  border:1px solid rgba(109,213,255,0.45); border-radius:10px; padding:0.9rem 1.2rem;
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(77,227,255,0.15) 100%);
  box-shadow:0 0 15px rgba(77,227,255,0.15);
  text-transform:uppercase; color:var(--cyan);
  transition:border-color .18s ease, box-shadow .18s ease, transform .12s ease, color .18s ease;
  cursor: pointer; outline: none;
}
.btn:hover,.btn:focus-visible{
  box-shadow:0 0 24px rgba(77,227,255,0.35), 0 0 2px rgba(77,227,255,0.9) inset;
  transform:translateY(-1px);
}
.btn.active{
  border-color:rgba(255,77,243,0.7);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,77,243,0.15) 100%);
  box-shadow:0 0 24px rgba(255,77,243,0.35);
  color:var(--magenta);
}
.btn.enhanced {
  border-color:rgba(255,255,0,0.6);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,255,0,0.15) 100%);
  box-shadow:0 0 15px rgba(255,255,0,0.15);
  color:#ffff00;
}
.btn.enhanced::after {
  content: ' [ENHANCED]';
  font-size: 0.7em;
  opacity: 0.8;
}
.layer{ position:absolute; inset:0; pointer-events:none; z-index:1; }
.light-spill{
  background:radial-gradient(circle at var(--mx) var(--my), rgba(77,227,255,0.18), transparent 40%);
  mix-blend-mode:screen;
}
.mount{
  width:min(420px, 44vmin); aspect-ratio:1/1;
  background:transparent; border:1px solid rgba(77,227,255,0.45);
  box-shadow:0 0 26px rgba(77,227,255,0.25);
  border-radius:12px; position:relative; z-index:2;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}

/* Idle State */
.idle-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  background: radial-gradient(ellipse at center, 
      rgba(77,227,255,0.15) 0%, 
      rgba(77,227,255,0.08) 50%, 
      transparent 70%);
  border-radius: 12px;
  animation: pulse-idle 3s ease-in-out infinite;
  display: flex;
  align-items: center;
  justify-content: center;
}

.idle-particles::before {
  content: '';
  width: 60px;
  height: 60px;
  border: 2px solid rgba(77,227,255,0.4);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 2s linear infinite;
}

.idle-particles::after {
  content: 'SELECT ORACLE';
  position: absolute;
  bottom: 25%;
  font-family: var(--title-font);
  color: rgba(77,227,255,0.8);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px rgba(77,227,255,0.5);
  animation: pulse-text 2s ease-in-out infinite;
}

/* WebRTC Video */
.webrtc-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 12px;
  display: none;
}

.webrtc-video.active {
  display: block;
}

/* Visual filters for each persona */
.persona-bigfoot .webrtc-video {
  filter: sepia(30%) hue-rotate(30deg) saturate(1.3) brightness(0.95);
}

.persona-indiana .webrtc-video {
  filter: hue-rotate(0deg) saturate(1.1) brightness(1.05) contrast(1.05);
}

.persona-vonnegut .webrtc-video {
  filter: sepia(15%) hue-rotate(200deg) saturate(0.9) contrast(1.15) brightness(0.98);
}

/* Loading overlay */
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  z-index: 10;
}

.loading-overlay::after {
  content: 'CONNECTING...';
  font-family: var(--title-font);
  color: var(--cyan);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px var(--cyan);
  animation: pulse-text 1.5s ease-in-out infinite;
}

.status-display {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: rgba(0,0,0,0.8);
  border: 1px solid rgba(77,227,255,0.3);
  border-radius: 8px;
  font-size: 12px;
  z-index: 20;
  text-align: center;
  min-width: 200px;
  font-family: var(--ui-font);
}

/* Animations */
@keyframes pulse-idle {
  0%, 100% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse-text {
  0%, 100% { opacity: 0.6; text-shadow: 0 0 5px currentColor; }
  50% { opacity: 1; text-shadow: 0 0 15px currentColor; }
}
</style>
</head>
<body>
<div class="layer light-spill" id="parallaxLayer"></div>

<div class="status-display" id="statusDisplay">
    System: WebRTC Compose Ready
</div>

<div class="w-full text-center mt-6 select-none">
  <h1 class="text-2xl md:text-4xl tracking-wider">ECHOES OF INDIANA</h1>
  <div class="subtitle text-xs md:text-sm mt-1">LIVE WEBRTC CONVERSATIONS</div>
</div>

<main class="w-full h-[70vh] flex items-center justify-center">
  <div class="mount" id="videoMount">
    <!-- Idle State -->
    <div class="idle-particles" id="idleParticles"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay"></div>
    
    <!-- WebRTC Video Stream -->
    <video id="webrtcVideo" class="webrtc-video" autoplay playsinline muted></video>
    <audio id="webrtcAudio" autoplay></audio>
  </div>
</main>

<footer class="flex gap-6 justify-center pb-10">
  <button class="btn" data-persona="bigfoot" onclick="switchPersona('bigfoot')">Brown County Bigfoot</button>
  <button class="btn" data-persona="indiana" onclick="switchPersona('indiana')">Hoosier Oracle</button>
  <button class="btn enhanced" data-persona="vonnegut" onclick="switchPersona('vonnegut')">Kurt Vonnegut</button>
</footer>

<script>
console.log('ðŸš€ LOADING WEBRTC COMPOSE ORACLE');

// Mouse parallax effect
(function(){
  const light = document.getElementById('parallaxLayer');
  if(!light) return;
  let mx=50, my=50, ticking=false;
  function update(){
    light.style.setProperty('--mx', mx + '%');
    light.style.setProperty('--my', my + '%');
    ticking=false;
  }
  addEventListener('mousemove', e=>{
    mx = (e.clientX / innerWidth) * 100;
    my = (e.clientY / innerHeight) * 100;
    if(!ticking){ requestAnimationFrame(update); ticking=true; }
  }, { passive:true });
})();

// Configuration
const CONFIG = {
    personas: {
        bigfoot: { 
            name: 'Brown County Bigfoot', 
            faceId: '4a857f92-feee-4b70-b973-290baec4d545',
            enhanced: false
        },
        indiana: { 
            name: 'Hoosier Oracle', 
            faceId: '76ed1ae8-720c-45de-918c-cac46984412d',
            enhanced: false
        },
        vonnegut: { 
            name: 'Kurt Vonnegut', 
            faceId: '7bcb45a5-839c-4f1a-b6f9-4ebcdf457264',
            enhanced: true
        }
    },
    currentSession: null,
    peerConnection: null,
    dataChannel: null
};

const API_BASE = window.location.origin;

// State Management
let currentState = 'IDLE';
let currentPersona = null;

// DOM Elements
const idleParticles = document.getElementById('idleParticles');
const loadingOverlay = document.getElementById('loadingOverlay');
const statusDisplay = document.getElementById('statusDisplay');
const videoMount = document.getElementById('videoMount');
const webrtcVideo = document.getElementById('webrtcVideo');
const webrtcAudio = document.getElementById('webrtcAudio');

function updateStatus(message) {
    statusDisplay.textContent = `System: ${message}`;
    console.log(`[WebRTC Oracle] ${message}`);
}

async function switchPersona(personaId) {
    if (currentState === 'CONNECTING') return;
    
    console.log(`[WebRTC Oracle] Switching to: ${personaId}`);
    
    // Update button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-persona="${personaId}"]`).classList.add('active');
    
    // End current session if active
    if (currentState === 'LIVE') {
        await endSession();
    }
    
    // Start new session
    await startWebRTCSession(personaId);
}

async function startWebRTCSession(personaId) {
    const persona = CONFIG.personas[personaId];
    currentState = 'CONNECTING';
    currentPersona = personaId;
    
    updateStatus(`Summoning ${persona.name}...`);
    
    // Hide idle and show loading
    idleParticles.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    try {
        // 1. Create Simli Compose session
        const response = await fetch(`${API_BASE}/simli-compose/session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                persona: personaId,
                faceId: persona.faceId 
            })
        });
        
        const sessionData = await response.json();
        
        if (!sessionData.token) {
            throw new Error('Failed to create Simli session: ' + (sessionData.message || 'No token received'));
        }
        
        CONFIG.currentSession = sessionData;
        console.log('[WebRTC Oracle] Session created:', sessionData);
        
        // 2. Initialize WebRTC connection
        await initializeWebRTC(sessionData, personaId);
        
    } catch (error) {
        console.error('[WebRTC Oracle] Session creation failed:', error);
        updateStatus(`Connection failed: ${error.message}`);
        returnToIdle();
    }
}

async function initializeWebRTC(sessionData, personaId) {
    const persona = CONFIG.personas[personaId];
    
    updateStatus(`Initializing WebRTC for ${persona.name}...`);
    
    try {
        // Create RTCPeerConnection
        CONFIG.peerConnection = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        });
        
        const pc = CONFIG.peerConnection;
        
        // Handle incoming media stream
        pc.ontrack = (event) => {
            console.log('[WebRTC Oracle] Received media stream');
            const stream = event.streams[0];
            
            // Set video stream
            webrtcVideo.srcObject = stream;
            
            // Show video with persona styling
            videoMount.className = `mount persona-${personaId}`;
            webrtcVideo.classList.add('active');
            
            // Hide loading
            loadingOverlay.style.display = 'none';
            
            currentState = 'LIVE';
            if (persona.enhanced) {
                updateStatus(`${persona.name} Active - Enhanced WebRTC`);
            } else {
                updateStatus(`${persona.name} Active - WebRTC Live`);
            }
        };
        
        pc.oniceconnectionstatechange = () => {
            console.log('[WebRTC Oracle] ICE connection state:', pc.iceConnectionState);
            if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                updateStatus('Connection lost - attempting reconnect...');
            }
        };
        
        // Create data channel for communication
        CONFIG.dataChannel = pc.createDataChannel('simli', { ordered: true });
        
        CONFIG.dataChannel.onopen = () => {
            console.log('[WebRTC Oracle] Data channel opened');
        };
        
        CONFIG.dataChannel.onmessage = (event) => {
            console.log('[WebRTC Oracle] Data channel message:', event.data);
        };
        
        // Create offer and set local description
        const offer = await pc.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
        });
        
        await pc.setLocalDescription(offer);
        
        // Send offer to Simli WebRTC endpoint
        const webrtcResponse = await fetch('https://api.simli.ai/webrtc/offer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sessionToken: sessionData.token,
                faceId: persona.faceId,
                offer: offer,
                model: 'fasttalk' // Use fasttalk model for trinity avatars
            })
        });
        
        const webrtcData = await webrtcResponse.json();
        
        if (!webrtcData.answer) {
            throw new Error('No WebRTC answer received from Simli');
        }
        
        // Set remote description
        await pc.setRemoteDescription(new RTCSessionDescription(webrtcData.answer));
        
        console.log('[WebRTC Oracle] WebRTC connection established');
        
    } catch (error) {
        console.error('[WebRTC Oracle] WebRTC initialization failed:', error);
        updateStatus(`WebRTC failed: ${error.message}`);
        
        // Fallback to placeholder
        showPlaceholder(personaId);
    }
}

function showPlaceholder(personaId) {
    const persona = CONFIG.personas[personaId];
    
    // Hide loading
    loadingOverlay.style.display = 'none';
    
    // Create placeholder
    const placeholder = document.createElement('div');
    placeholder.id = 'avatarPlaceholder';
    placeholder.style.cssText = `
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: var(--title-font);
        font-size: 14px;
        color: var(--cyan);
        text-shadow: 0 0 10px currentColor;
        letter-spacing: 1px;
        border-radius: 12px;
        background: radial-gradient(ellipse at center, 
            rgba(77,227,255,0.1) 0%, 
            transparent 70%);
    `;
    placeholder.textContent = `${persona.name.toUpperCase()} READY`;
    
    // Apply persona styling
    videoMount.className = `mount persona-${personaId}`;
    videoMount.appendChild(placeholder);
    
    currentState = 'LIVE';
    updateStatus(`${persona.name} Ready (Placeholder Mode)`);
}

async function endSession() {
    if (currentState !== 'LIVE') return;
    
    currentState = 'ENDING';
    updateStatus('Ending session...');
    
    // Close WebRTC connection
    if (CONFIG.dataChannel) {
        CONFIG.dataChannel.close();
        CONFIG.dataChannel = null;
    }
    
    if (CONFIG.peerConnection) {
        CONFIG.peerConnection.close();
        CONFIG.peerConnection = null;
    }
    
    // Hide video
    webrtcVideo.classList.remove('active');
    webrtcVideo.srcObject = null;
    
    // Remove placeholder
    const placeholder = document.getElementById('avatarPlaceholder');
    if (placeholder) {
        placeholder.remove();
    }
    
    // Clean up session
    CONFIG.currentSession = null;
    
    setTimeout(() => {
        returnToIdle();
    }, 1000);
}

function returnToIdle() {
    currentState = 'IDLE';
    currentPersona = null;
    
    updateStatus('WebRTC Compose Ready');
    
    // Reset video mount
    videoMount.className = 'mount';
    
    // Hide loading
    loadingOverlay.style.display = 'none';
    
    // Show idle particles
    idleParticles.style.display = 'flex';
    
    // Clear button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// Initialize
window.addEventListener('load', async () => {
    console.log('ðŸš€ WebRTC Oracle Kiosk Initialized');
    updateStatus('WebRTC Compose Ready - Select an Oracle');
    
    // ESC key handler
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentState === 'LIVE') {
            endSession();
        }
    });
});
</script>
</body>
</html>