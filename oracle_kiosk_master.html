<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Echoes of Indiana â€” Master Oracle</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' https://cdn.tailwindcss.com https://app.simli.com https://unpkg.com 'unsafe-inline'; connect-src 'self' https://api.simli.ai https://app.simli.com wss://api.simli.ai; frame-src 'self' https://app.simli.com; media-src 'self' blob: https://api.simli.ai;"/>

<!-- Using Compose API with WebRTC - Widget SDK not needed -->

<link rel="stylesheet" href="/assets/tailwind.css">
<link href="https://fonts.googleapis.com/css2?family=Michroma&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --cyan:#4de3ff; --magenta:#ff4df3; --violet:#7e6bff;
  --mx:50%; --my:50%;
  --title-font:'Michroma', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --ui-font:'Rajdhani', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
html, body { height:100%; }
body{
  margin:0; padding:0; overflow:hidden; color:#e7faff;
  font-family:var(--ui-font);
  background:#000 url('/assets/landing-foreground2.png') center center / cover no-repeat fixed;
}
h1{
  font-family:var(--title-font);
  text-shadow:0 0 8px var(--cyan), 0 0 20px var(--cyan), 0 0 38px var(--violet);
  font-weight:700; letter-spacing:0.08em; text-transform:uppercase;
}
.subtitle{
  font-family:var(--title-font);
  text-transform:uppercase; letter-spacing:0.14em;
  color:var(--magenta);
  text-shadow:0 0 8px var(--magenta), 0 0 22px var(--magenta);
}
.btn{
  font-family:var(--ui-font);
  border:1px solid rgba(109,213,255,0.45); border-radius:10px; padding:0.9rem 1.2rem;
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(77,227,255,0.15) 100%);
  box-shadow:0 0 15px rgba(77,227,255,0.15);
  text-transform:uppercase; color:var(--cyan);
  transition:border-color .18s ease, box-shadow .18s ease, transform .12s ease, color .18s ease;
  cursor: pointer;
  outline: none;
}
.btn:hover,.btn:focus-visible{
  box-shadow:0 0 24px rgba(77,227,255,0.35), 0 0 2px rgba(77,227,255,0.9) inset;
  transform:translateY(-1px);
}
.btn.active{
  border-color:rgba(255,77,243,0.7);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,77,243,0.15) 100%);
  box-shadow:0 0 24px rgba(255,77,243,0.35);
  color:var(--magenta);
}
.btn.enhanced {
  border-color:rgba(255,255,0,0.6);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,255,0,0.15) 100%);
  box-shadow:0 0 15px rgba(255,255,0,0.15);
  color:#ffff00;
}
.btn.enhanced:hover {
  box-shadow:0 0 24px rgba(255,255,0,0.35), 0 0 2px rgba(255,255,0,0.9) inset;
}
.btn.enhanced::after {
  content: ' [ENHANCED]';
  font-size: 0.7em;
  opacity: 0.8;
}
.layer{ position:absolute; inset:0; pointer-events:none; z-index:1; }
.light-spill{
  background:radial-gradient(circle at var(--mx) var(--my), rgba(77,227,255,0.18), transparent 40%);
  mix-blend-mode:screen;
}
.mount{
  width:512px; height:512px;
  background:transparent; border:1px solid rgba(77,227,255,0.45);
  box-shadow:0 0 26px rgba(77,227,255,0.25);
  border-radius:12px; position:relative; z-index:2;
  display: flex; align-items: center; justify-content: center;
}

/* Idle State */
.idle-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  background: radial-gradient(ellipse at center, 
      rgba(77,227,255,0.15) 0%, 
      rgba(77,227,255,0.08) 50%, 
      transparent 70%);
  border-radius: 12px;
  animation: pulse-idle 3s ease-in-out infinite;
  display: flex;
  align-items: center;
  justify-content: center;
}

.idle-particles::before {
  content: '';
  width: 60px;
  height: 60px;
  border: 2px solid rgba(77,227,255,0.4);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 2s linear infinite;
}

.idle-particles::after {
  content: 'SELECT ORACLE';
  position: absolute;
  bottom: 25%;
  font-family: var(--title-font);
  color: rgba(77,227,255,0.8);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px rgba(77,227,255,0.5);
  animation: pulse-text 2s ease-in-out infinite;
}

/* Avatar containers for 3 DIFFERENT visual styles */
.avatar-simli {
  position: absolute;
  width: 100%;
  height: 100%;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  overflow: hidden;
}

.avatar-simli.active {
  display: flex;
}

/* Visual differentiation for each avatar */
.avatar-bigfoot {
  filter: sepia(30%) hue-rotate(30deg) saturate(1.3) brightness(0.95);
  border: 1px solid rgba(139,69,19,0.6);
  box-shadow: 0 0 20px rgba(139,69,19,0.3);
}

.avatar-indiana {
  filter: hue-rotate(0deg) saturate(1.1) brightness(1.05) contrast(1.05);
  border: 1px solid rgba(77,227,255,0.6);
  box-shadow: 0 0 20px rgba(77,227,255,0.3);
}

.avatar-vonnegut {
  filter: sepia(15%) hue-rotate(200deg) saturate(0.9) contrast(1.15) brightness(0.98);
  border: 1px solid rgba(255,255,0,0.6);
  box-shadow: 0 0 20px rgba(255,255,0,0.3);
}

/* Enhanced badge */
.enhanced-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: linear-gradient(45deg, #ffff00, #ff8c00);
  color: #000;
  padding: 3px 6px;
  border-radius: 8px;
  font-size: 7px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: none;
  z-index: 5;
}

.avatar-vonnegut .enhanced-badge {
  display: block;
}

/* Loading/Connection states */
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  z-index: 10;
}

.loading-overlay::after {
  content: 'CONNECTING...';
  font-family: var(--title-font);
  color: var(--cyan);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px var(--cyan);
  animation: pulse-text 1.5s ease-in-out infinite;
}

/* Status display */
.status-display {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: rgba(0,0,0,0.8);
  border: 1px solid rgba(77,227,255,0.3);
  border-radius: 8px;
  font-size: 12px;
  z-index: 20;
  text-align: center;
  min-width: 200px;
  font-family: var(--ui-font);
}

/* Test panel */
.test-panel {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  background: rgba(0,0,0,0.9);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(77,227,255,0.3);
  z-index: 25;
}

.test-panel input {
  width: 300px;
  padding: 6px 10px;
  background: rgba(77,227,255,0.1);
  border: 1px solid rgba(77,227,255,0.3);
  border-radius: 5px;
  color: var(--cyan);
  font-size: 12px;
  font-family: var(--ui-font);
  margin-right: 8px;
}

.test-panel input::placeholder {
  color: rgba(77,227,255,0.5);
}

.test-panel button {
  padding: 6px 12px;
  background: linear-gradient(135deg, rgba(77,227,255,0.2), rgba(126,107,255,0.2));
  border: 1px solid rgba(77,227,255,0.4);
  border-radius: 5px;
  color: var(--cyan);
  cursor: pointer;
  font-size: 11px;
  font-family: var(--ui-font);
  margin: 0 2px;
}

.test-toggle {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,0,0.2);
  border: 1px solid #ffff00;
  color: #ffff00;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 9px;
  cursor: pointer;
  z-index: 30;
  font-family: var(--ui-font);
}

/* Animations */
@keyframes pulse-idle {
  0%, 100% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse-text {
  0%, 100% { opacity: 0.6; text-shadow: 0 0 5px currentColor; }
  50% { opacity: 1; text-shadow: 0 0 15px currentColor; }
}
</style>
</head>
<body>
<div class="layer light-spill" id="parallaxLayer"></div>

<!-- Status Display -->
<div class="status-display" id="statusDisplay">
    System: Master Oracle Interface Ready
</div>

<!-- Test Toggle Button -->
<button class="test-toggle" onclick="toggleTestPanel()">
    REMOTE TEST
</button>

<div class="w-full text-center mt-6 select-none">
  <h1 class="text-2xl md:text-4xl tracking-wider">ECHOES OF INDIANA</h1>
  <div class="subtitle text-xs md:text-sm mt-1">LIVE HOLOGRAPHIC CONVERSATIONS POWERED BY RESEARCH</div>
</div>

<main class="w-full h-[70vh] flex items-center justify-center">
  <div class="mount" aria-label="Oracle avatar mount">
    <!-- Idle State -->
    <div class="idle-particles" id="idleParticles"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay"></div>
    
    <!-- Bigfoot Avatar Container -->
    <div class="avatar-simli avatar-bigfoot" id="avatarBigfoot">
      <div class="enhanced-badge">CRYPTID</div>
    </div>
    
    <!-- Indiana Avatar Container -->
    <div class="avatar-simli avatar-indiana" id="avatarIndiana">
      <div class="enhanced-badge">ORACLE</div>
    </div>
    
    <!-- Vonnegut Avatar Container -->
    <div class="avatar-simli avatar-vonnegut" id="avatarVonnegut">
      <div class="enhanced-badge">ENHANCED</div>
    </div>
  </div>
</main>

<footer class="flex gap-6 justify-center pb-10">
  <button class="btn" data-persona="bigfoot" onclick="switchPersona('bigfoot')">Brown County Bigfoot</button>
  <button class="btn" data-persona="indiana" onclick="switchPersona('indiana')">Hoosier Oracle</button>
  <button class="btn enhanced" data-persona="vonnegut" onclick="switchPersona('vonnegut')">Kurt Vonnegut</button>
</footer>

<!-- Remote Test Panel -->
<div class="test-panel" id="testPanel">
    <input type="text" id="testInput" placeholder="Enter test text..." maxlength="200">
    <button onclick="sendTestText()">Send</button>
    <button onclick="toggleTestPanel()">Close</button>
</div>

<script>
const DEBUG = false;
if (DEBUG) console.log('ðŸš€ LOADING MASTER ORACLE KIOSK - Beautiful Design');

// Mouse parallax effect
(function(){
  const light = document.getElementById('parallaxLayer');
  if(!light) return;
  let mx=50, my=50, ticking=false;
  function update(){
    light.style.setProperty('--mx', mx + '%');
    light.style.setProperty('--my', my + '%');
    ticking=false;
  }
  addEventListener('mousemove', e=>{
    mx = (e.clientX / innerWidth) * 100;
    my = (e.clientY / innerHeight) * 100;
    if(!ticking){ requestAnimationFrame(update); ticking=true; }
  }, { passive:true });
})();

// Configuration - Using Compose API with Face IDs (WORKING APPROACH)
const CONFIG = {
    personas: {
        bigfoot: { 
            name: 'Brown County Bigfoot', 
            faceId: '6926a39d-638b-49c5-9328-79efa034e9a4', // Face IDs for Compose API
            enhanced: false
        },
        indiana: { 
            name: 'Hoosier Oracle', 
            faceId: '0c2b8b04-5274-41f1-a21c-d5c98322efa9', // Face IDs for Compose API
            enhanced: false
        },
        vonnegut: { 
            name: 'Kurt Vonnegut', 
            faceId: '6ebf0aa7-6fed-443d-a4c6-fd1e3080b215', // Face IDs for Compose API
            enhanced: true
        }
    },
    currentSession: null,
    useComposeAPI: true // Back to Compose API - this was working!
};

const API_BASE = window.location.origin;

// State Management
let currentState = 'IDLE';
let currentPersona = null;
let activeWidget = null;

// DOM Elements
const idleParticles = document.getElementById('idleParticles');
const loadingOverlay = document.getElementById('loadingOverlay');
const statusDisplay = document.getElementById('statusDisplay');
const testPanel = document.getElementById('testPanel');
const testInput = document.getElementById('testInput');

function updateStatus(message) {
    statusDisplay.textContent = `System: ${message}`;
    if (DEBUG) console.log(`[Master Oracle] ${message}`);
}

function toggleTestPanel() {
    testPanel.style.display = testPanel.style.display === 'none' ? 'block' : 'none';
}

async function sendTestText() {
    const text = testInput.value.trim();
    if (!text) {
        alert('Please enter test text');
        return;
    }
    
    if (!currentPersona) {
        alert('Please select a persona first');
        return;
    }
    
    updateStatus(`Testing ${CONFIG.personas[currentPersona].name}...`);
    
    try {
        if (currentPersona === 'vonnegut') {
            // Use enhanced Vonnegut endpoint
            const response = await fetch(`${API_BASE}/test-vonnegut-text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            
            const result = await response.json();
            if (result.success) {
                updateStatus(`Vonnegut: "${result.vonnegut_response.substring(0, 40)}..."`);
            } else {
                updateStatus(`Error: ${result.error}`);
            }
        } else {
            // Use Compose speak endpoint
            const response = await fetch(`${API_BASE}/simli-compose/speak`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ persona: currentPersona, text: text })
            });
            
            const result = await response.json();
            if (result.success) {
                updateStatus(`${result.message}`);
            } else {
                updateStatus(`Error: ${result.error}`);
            }
        }
        
    } catch (error) {
        console.error('Test error:', error);
        updateStatus(`Connection error: ${error.message}`);
    }
    
    testInput.value = '';
}

let transitionTimer = null;

async function switchPersona(personaId) {
    if (currentState === 'CONNECTING') return;
    
    if (DEBUG) console.log(`[Master Oracle] Switching to: ${personaId}`);
    
    // Update button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-persona="${personaId}"]`).classList.add('active');
    
    // End current session if active
    if (currentState === 'LIVE') {
        await endSession();
    }
    
    // Cancel any pending transition from previous selection
    if (transitionTimer) {
        clearTimeout(transitionTimer);
        transitionTimer = null;
    }

    // Start transition sequence
    currentState = 'CONNECTING';
    currentPersona = personaId;
    
    const persona = CONFIG.personas[personaId];
    updateStatus(`Summoning ${persona.name}...`);
    
    // Hide idle particles and show loading
    idleParticles.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    // Simulate transition
    transitionTimer = setTimeout(async () => {
        // If user switched again during delay, abort this run
        if (personaId !== currentPersona) return;
        await loadAvatar(personaId);
    }, 2000);
}

async function loadAvatar(personaId) {
    console.log(`[DEBUG] loadAvatar(${personaId}) called`);
    const persona = CONFIG.personas[personaId];
    
    try {
        if (CONFIG.useComposeAPI) {
            console.log(`[DEBUG] Using Compose API for ${personaId}`);
            // Create Compose session (WORKING APPROACH)
            const url = `${API_BASE}/simli-compose/session?persona=${encodeURIComponent(personaId)}`;
            console.log(`[DEBUG] Fetching: ${url}`);
            
            const response = await fetch(url, {
                method: 'POST'
            });
            
            console.log(`[DEBUG] Response status: ${response.status}`);
            const sessionData = await response.json();
            console.log(`[DEBUG] Session data:`, sessionData);
            
            // If user switched during fetch, ignore this result
            if (personaId !== currentPersona) {
                console.log(`[DEBUG] User switched away from ${personaId}, ignoring result`);
                return;
            }

            if (sessionData.token) {
                CONFIG.currentSession = sessionData;
                console.log(`[DEBUG] Calling showAvatar for ${personaId}`);
                showAvatar(personaId);
                if (persona.enhanced) {
                    updateStatus(`${persona.name} Active - Enhanced Corpus`);
                } else {
                    updateStatus(`${persona.name} Active - Compose Mode`);
                }
                currentState = 'LIVE';
            } else {
                throw new Error('Failed to create Compose session - no token');
            }
        } else {
            console.log(`[DEBUG] Using Widget API for ${personaId}`);
            // Use Widget API (fallback)
            await loadSimliWidget(personaId);
        }
        
    } catch (error) {
        console.error(`[DEBUG] Error in loadAvatar(${personaId}):`, error);
        updateStatus(`Connection failed: ${error.message}`);
        returnToIdle();
    }
}

function showAvatar(personaId) {
    try {
        console.log(`[DEBUG] showAvatar START for ${personaId}`);
        
        // Hide loading
        loadingOverlay.style.display = 'none';
        console.log(`[DEBUG] Loading overlay hidden`);
        
        // Hide all avatars
        document.querySelectorAll('.avatar-simli').forEach(avatar => {
            avatar.classList.remove('active');
            avatar.innerHTML = ''; // Clear previous content
        });
        console.log(`[DEBUG] All avatars cleared`);
        
        // Show selected avatar with proper styling
        const avatarElementId = `avatar${personaId.charAt(0).toUpperCase() + personaId.slice(1)}`;
        const avatarElement = document.getElementById(avatarElementId);
        
        console.log(`[DEBUG] showAvatar(${personaId}) -> looking for element: ${avatarElementId}`, avatarElement);
        console.log(`[DEBUG] CONFIG.currentSession:`, CONFIG.currentSession);
        
        if (avatarElement) {
            console.log(`[DEBUG] Avatar element found, adding active class`);
            avatarElement.classList.add('active');
            
            // SIMPLE VIDEO ELEMENT APPROACH 
            if (CONFIG.currentSession && CONFIG.currentSession.token) {
                console.log(`[DEBUG] Creating video element for ${personaId}`);
            // Create video element for WebRTC stream
            const video = document.createElement('video');
            video.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 12px;
                background: #000;
            `;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = false;
            
            // Clear and add video
            avatarElement.innerHTML = '';
            avatarElement.appendChild(video);
            
            // Initialize WebRTC connection to show actual Simli video
            console.log(`[DEBUG] About to call initializeWebRTC for ${personaId}`);
            initializeWebRTC(video, personaId).catch(error => {
                console.error(`[DEBUG] initializeWebRTC failed for ${personaId}:`, error);
            });
            
            if (DEBUG) console.log(`[Master Oracle] Created video placeholder for ${personaId}`);
        } else {
            // Fallback placeholder if no session
            const placeholder = document.createElement('div');
            placeholder.className = 'avatar-placeholder';
            placeholder.style.cssText = `
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: var(--title-font);
                font-size: 14px;
                color: var(--cyan);
                text-shadow: 0 0 10px currentColor;
                letter-spacing: 1px;
            `;
            placeholder.textContent = `${CONFIG.personas[personaId].name.toUpperCase()} READY`;
            avatarElement.appendChild(placeholder);
        }
        }
        
        if (DEBUG) console.log(`[Master Oracle] Showing ${personaId} avatar with visual styling`);
        
    } catch (error) {
        console.error(`[DEBUG] Error in showAvatar(${personaId}):`, error);
        updateStatus(`Error displaying ${personaId}: ${error.message}`);
    }
}

async function loadSimliWidget(personaId) {
    // Widget implementation (fallback) 
    const persona = CONFIG.personas[personaId];
    showAvatar(personaId);
    updateStatus(`${persona.name} Active - Widget Mode`);
    currentState = 'LIVE';
}

async function endSession() {
    if (currentState !== 'LIVE') return;
    
    currentState = 'ENDING';
    updateStatus('Releasing spirit...');
    
    // Show loading briefly
    loadingOverlay.style.display = 'flex';
    
    // Clean up Simli widget - SDK handles its own cleanup when element is removed
    // Widget will be removed when avatar containers are cleared in returnToIdle()
    
    // Clean up session
    if (CONFIG.currentSession) {
        CONFIG.currentSession = null;
    }
    
    setTimeout(() => {
        returnToIdle();
    }, 1000);
}

function returnToIdle() {
    currentState = 'IDLE';
    currentPersona = null;
    CONFIG.currentSession = null;
    
    updateStatus('Master Oracle Interface Ready');
    
    // Hide loading
    loadingOverlay.style.display = 'none';
    
    // Show idle particles
    idleParticles.style.display = 'flex';
    
    // Hide all avatars
    document.querySelectorAll('.avatar-simli').forEach(avatar => {
        avatar.classList.remove('active');
    });
    
    // Clear button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// WebRTC Connection to Simli Compose API
async function initializeWebRTC(videoElement, personaId) {
    console.log(`[WebRTC] Initializing for ${personaId}`);
    console.log(`[WebRTC] Video element:`, videoElement);
    console.log(`[WebRTC] Session token:`, CONFIG.currentSession.token.substring(0, 10) + '...');
    
    try {
        console.log(`[WebRTC] About to create WebSocket connection`);
        // Create WebSocket connection to Simli
        const ws = new WebSocket('wss://api.simli.ai/v1/startAudioToVideoWebsocket');
        console.log(`[WebRTC] WebSocket created:`, ws);
        
        ws.onopen = () => {
            console.log(`[WebRTC] WebSocket connected for ${personaId}`);
            
            // Send session token to start video stream
            const initMessage = {
                type: 'session_token',
                session_token: CONFIG.currentSession.token,
                faceId: CONFIG.currentSession.faceId
            };
            
            ws.send(JSON.stringify(initMessage));
            console.log(`[WebRTC] Sent session token for ${personaId}`);
        };
        
        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            console.log(`[WebRTC] Message received for ${personaId}:`, message);
            
            if (message.type === 'video_stream_url') {
                // Set video source to Simli stream
                videoElement.src = message.url;
                updateStatus(`${CONFIG.personas[personaId].name} Connected!`);
            }
            
            if (message.type === 'webrtc_offer') {
                // Handle WebRTC offer from Simli
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.ontrack = (event) => {
                    console.log(`[WebRTC] Received video track for ${personaId}`);
                    videoElement.srcObject = event.streams[0];
                    updateStatus(`${CONFIG.personas[personaId].name} Live!`);
                };
                
                await pc.setRemoteDescription(message.offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                ws.send(JSON.stringify({
                    type: 'webrtc_answer',
                    answer: answer
                }));
            }
        };
        
        ws.onerror = (error) => {
            console.error(`[WebRTC] Error for ${personaId}:`, error);
            updateStatus(`${CONFIG.personas[personaId].name}: Connection Error`);
        };
        
        ws.onclose = () => {
            console.log(`[WebRTC] Connection closed for ${personaId}`);
            updateStatus(`${CONFIG.personas[personaId].name}: Disconnected`);
        };
        
    } catch (error) {
        console.error(`[WebRTC] Failed to initialize for ${personaId}:`, error);
        updateStatus(`${CONFIG.personas[personaId].name}: WebRTC Error`);
        
        // Show fallback info
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--cyan);
            text-align: center;
            font-size: 12px;
            font-family: var(--ui-font);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
        `;
        overlay.innerHTML = `
            <div>${CONFIG.personas[personaId].name}</div>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                Session: âœ…<br>
                Token: ${CONFIG.currentSession.token.substring(0, 8)}...<br>
                Face ID: ${CONFIG.currentSession.faceId.substring(0, 8)}...<br>
                <span style="color: #ff4444;">WebRTC: ERROR</span>
            </div>
        `;
        
        videoElement.parentElement.appendChild(overlay);
    }
}

// Initialize
window.addEventListener('load', async () => {
    console.log('ðŸš€ Master Oracle Kiosk Initialized - Beautiful Design');
    updateStatus('Master Oracle Interface Ready - Select an Oracle');
    
    // ESC key handler
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (currentState === 'LIVE') {
                endSession();
            }
            testPanel.style.display = 'none';
        }
    });
    
    // Enter key in test input
    testInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendTestText();
        }
    });
});
</script>
</body>
</html>