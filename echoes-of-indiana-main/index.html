<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Indiana</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <div id="click-to-start" class="click-to-start">
        <div class="start-prompt">Touch to Begin</div>
    </div>

    <div id="persona-menu" class="persona-menu">
        <div class="menu-header">ECHOES OF INDIANA</div>
        <div class="persona-list">
            <button class="persona-btn" data-persona="mabel">
                <div class="persona-thumbnail">
                    <video class="persona-preview" autoplay loop muted playsinline>
                        <source src="assets/images and ideas/for menu/33622e5c-6107-4da0-9794-8ea784ccdb43.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="persona-info">
                    <span class="persona-name">Mabel</span>
                    <span class="persona-role">Showers Worker, 1917</span>
                </div>
            </button>
        </div>
        <button id="btn-dismiss" class="dismiss-btn">Dismiss</button>
    </div>

    <!-- Loading Message -->
    <div id="loading-msg" class="loading-msg hidden">
        <div class="loading-text">Summoning...</div>
    </div>

    <!-- 
        STAGE: All video layers share the SAME head-container positioning
        Layer 2 = Abstract videos (idle loop, transitions)
        Layer 3 = Simli (appears on top when active)
    -->
    <!-- 
        MASTER STAGE - Everything renders inside this centered box
        All layers MUST conform to this container's bounds
    -->
    <div id="stage">
        <!-- 
            HOLOGRAM MOUNT - The sacred box where all layers live
            This is THE reference point for all positioning
            
            SANDWICH (bottom to top):
            z-index 1: Bottom floaties (future)
            z-index 2: Idle loop (always visible)
            z-index 3: Transition video
            z-index 4: Simli agent
            z-index 5: Top floaties (future)
        -->
        <div id="hologram-mount">
            <!-- Layer 1: Bottom floaties (future) -->
            <!-- <video id="video-floaties-bottom" class="layer layer-1" playsinline loop muted></video> -->
            
            <!-- Layer 2: Idle loop - ALWAYS PLAYING -->
            <video id="video-idle-loop" class="layer layer-2" playsinline loop muted></video>
            
            <!-- Layer 3: Transition video -->
            <video id="video-transition" class="layer layer-3" playsinline muted></video>
            
            <!-- Layer 4: Simli agent -->
            <div id="simli-mount" class="layer layer-4"></div>
            
            <!-- Layer 5: Top floaties (future) -->
            <!-- <video id="video-floaties-top" class="layer layer-5" playsinline loop muted></video> -->
        </div>
    </div>

    <div id="debug-panel" class="debug-panel">
        <div>State: <span id="debug-state">-</span></div>
        <div>Simli: <span id="debug-simli">-</span></div>
    </div>

    <script src="config.js"></script>
    <script src="state-machine.js"></script>
    <script src="simli-integration.js"></script>
    <script src="compositor.js"></script>
    
    <script>
        let isStarted = false;
        
        document.getElementById('click-to-start').addEventListener('click', () => {
            if (isStarted) return;
            isStarted = true;
            document.getElementById('click-to-start').classList.add('hidden');
            Compositor.startIdleLoop();
        });
        
        document.querySelectorAll('.persona-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-persona');
                if (!isStarted) {
                    isStarted = true;
                    document.getElementById('click-to-start').classList.add('hidden');
                    Compositor.startIdleLoop();
                }
                
                // Mark this button as active, remove from others
                document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('loading-msg').classList.remove('hidden');
                setTimeout(() => Compositor.invokePersona(id), 100);
            });
        });
        
        // DISMISS - Force cleanup regardless of state
        document.getElementById('btn-dismiss').addEventListener('click', () => {
            console.log('[UI] Dismiss clicked - forcing cleanup');
            document.getElementById('loading-msg').classList.add('hidden');
            
            // Remove active state from all persona buttons
            document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
            
            Compositor.forceReset();
        });

        document.addEventListener('simli-video-ready', () => {
            document.getElementById('loading-msg').classList.add('hidden');
        });

        document.addEventListener('statechange', (e) => {
            if (e.detail.state === 'idle') {
                document.getElementById('loading-msg').classList.add('hidden');
                // Remove active state when returning to idle
                document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
            }
            document.getElementById('debug-state').textContent = e.detail.state;
        });

        // DEBUG MODE: Add ?debug=borders to URL to see layer boundaries
        // Red = hologram-mount, Blue = idle, Green = transition, Yellow = simli, Magenta = widget
        if (new URLSearchParams(window.location.search).get('debug') === 'borders') {
            document.body.classList.add('debug-borders');
            console.log('[DEBUG] Border mode enabled - showing layer boundaries');
        }
        
        // MEASURE MODE: Add ?measure to URL to show measurement grid
        if (new URLSearchParams(window.location.search).get('measure') !== null) {
            const mount = document.getElementById('hologram-mount');
            const grid = document.createElement('div');
            grid.id = 'measure-grid';
            grid.innerHTML = `
                <div class="crosshair-h"></div>
                <div class="crosshair-v"></div>
                <div class="grid-label" style="top:0;left:50%;transform:translateX(-50%)">TOP</div>
                <div class="grid-label" style="bottom:0;left:50%;transform:translateX(-50%)">BOTTOM</div>
                <div class="grid-label" style="left:0;top:50%;transform:translateY(-50%)">LEFT</div>
                <div class="grid-label" style="right:0;top:50%;transform:translateY(-50%)">RIGHT</div>
                <div class="grid-label" style="top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px">CENTER</div>
                <div class="grid-line h25"></div>
                <div class="grid-line h75"></div>
                <div class="grid-line v25"></div>
                <div class="grid-line v75"></div>
            `;
            mount.appendChild(grid);
            console.log('[MEASURE] Grid overlay enabled');
        }
    </script>
</body>
</html>
