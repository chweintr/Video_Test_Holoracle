<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Indiana</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <div id="click-to-start" class="click-to-start">
        <div class="start-prompt">Touch to Begin</div>
    </div>

    <div id="persona-menu" class="persona-menu">
        <div class="menu-header">ECHOES OF INDIANA</div>
        <div class="persona-list">
            <button class="persona-btn" data-persona="mabel">
                <span class="persona-name">Mabel</span>
                <span class="persona-role">Showers Worker, 1917</span>
            </button>
        </div>
        <button id="btn-dismiss" class="dismiss-btn">Dismiss</button>
    </div>

    <!-- Loading Message -->
    <div id="loading-msg" class="loading-msg hidden">
        <div class="loading-text">Summoning...</div>
    </div>

    <!-- 
        STAGE: All video layers share the SAME head-container positioning
        Layer 2 = Abstract videos (idle loop, transitions)
        Layer 3 = Simli (appears on top when active)
    -->
    <!-- 
        MASTER STAGE - Everything renders inside this centered box
        All layers MUST conform to this container's bounds
    -->
    <div id="stage">
        <!-- 
            HOLOGRAM MOUNT - The sacred box where all layers live
            This is THE reference point for all positioning
            
            SANDWICH (bottom to top):
            z-index 1: Bottom floaties (future)
            z-index 2: Idle loop (always visible)
            z-index 3: Transition video
            z-index 4: Simli agent
            z-index 5: Top floaties (future)
        -->
        <div id="hologram-mount">
            <!-- Layer 1: Bottom floaties (future) -->
            <!-- <video id="video-floaties-bottom" class="layer layer-1" playsinline loop muted></video> -->
            
            <!-- Layer 2: Idle loop - ALWAYS PLAYING -->
            <video id="video-idle-loop" class="layer layer-2" playsinline loop muted></video>
            
            <!-- Layer 3: Transition video -->
            <video id="video-transition" class="layer layer-3" playsinline muted></video>
            
            <!-- Layer 4: Simli agent -->
            <div id="simli-mount" class="layer layer-4"></div>
            
            <!-- Layer 5: Top floaties (future) -->
            <!-- <video id="video-floaties-top" class="layer layer-5" playsinline loop muted></video> -->
        </div>
    </div>

    <div id="debug-panel" class="debug-panel">
        <div>State: <span id="debug-state">-</span></div>
        <div>Simli: <span id="debug-simli">-</span></div>
    </div>

    <script src="config.js"></script>
    <script src="state-machine.js"></script>
    <script src="simli-integration.js"></script>
    <script src="compositor.js"></script>
    
    <script>
        let isStarted = false;
        
        document.getElementById('click-to-start').addEventListener('click', () => {
            if (isStarted) return;
            isStarted = true;
            document.getElementById('click-to-start').classList.add('hidden');
            Compositor.startIdleLoop();
        });
        
        document.querySelectorAll('.persona-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-persona');
                if (!isStarted) {
                    isStarted = true;
                    document.getElementById('click-to-start').classList.add('hidden');
                    Compositor.startIdleLoop();
                }
                document.getElementById('loading-msg').classList.remove('hidden');
                setTimeout(() => Compositor.invokePersona(id), 100);
            });
        });
        
        // DISMISS - Force cleanup regardless of state
        document.getElementById('btn-dismiss').addEventListener('click', () => {
            console.log('[UI] Dismiss clicked - forcing cleanup');
            document.getElementById('loading-msg').classList.add('hidden');
            Compositor.forceReset();
        });

        document.addEventListener('simli-video-ready', () => {
            document.getElementById('loading-msg').classList.add('hidden');
        });

        document.addEventListener('statechange', (e) => {
            if (e.detail.state === 'idle') {
                document.getElementById('loading-msg').classList.add('hidden');
            }
            document.getElementById('debug-state').textContent = e.detail.state;
        });
    </script>
</body>
</html>
