<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Echoes of Indiana â€” Master Oracle</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' https://cdn.tailwindcss.com https://app.simli.com https://unpkg.com 'unsafe-inline'; connect-src 'self' https://api.simli.ai https://app.simli.com wss:;"/>

<!-- Simli Widget Script -->
<script src="https://app.simli.com/simli-widget/index.js" async type="text/javascript" 
        onload="console.log('âœ… Simli script loaded successfully')" 
        onerror="console.error('âŒ Failed to load Simli script from CDN')"></script>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Michroma&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --cyan:#4de3ff; --magenta:#ff4df3; --violet:#7e6bff;
  --mx:50%; --my:50%;
  --title-font:'Michroma', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --ui-font:'Rajdhani', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
html, body { height:100%; }
body{
  margin:0; padding:0; overflow:hidden; color:#e7faff;
  font-family:var(--ui-font);
  background:#000 url('/assets/landing-foreground2.png') center center / cover no-repeat fixed;
}
h1{
  font-family:var(--title-font);
  text-shadow:0 0 8px var(--cyan), 0 0 20px var(--cyan), 0 0 38px var(--violet);
  font-weight:700; letter-spacing:0.08em; text-transform:uppercase;
}
.subtitle{
  font-family:var(--title-font);
  text-transform:uppercase; letter-spacing:0.14em;
  color:var(--magenta);
  text-shadow:0 0 8px var(--magenta), 0 0 22px var(--magenta);
}
.btn{
  font-family:var(--ui-font);
  border:1px solid rgba(109,213,255,0.45); border-radius:10px; padding:0.9rem 1.2rem;
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(77,227,255,0.15) 100%);
  box-shadow:0 0 15px rgba(77,227,255,0.15);
  text-transform:uppercase; color:var(--cyan);
  transition:border-color .18s ease, box-shadow .18s ease, transform .12s ease, color .18s ease;
  cursor: pointer;
  outline: none;
}
.btn:hover,.btn:focus-visible{
  box-shadow:0 0 24px rgba(77,227,255,0.35), 0 0 2px rgba(77,227,255,0.9) inset;
  transform:translateY(-1px);
}
.btn.active{
  border-color:rgba(255,77,243,0.7);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,77,243,0.15) 100%);
  box-shadow:0 0 24px rgba(255,77,243,0.35);
  color:var(--magenta);
}
.btn.enhanced {
  border-color:rgba(255,255,0,0.6);
  background:linear-gradient(135deg, rgba(0,0,0,0.40) 0%, rgba(255,255,0,0.15) 100%);
  box-shadow:0 0 15px rgba(255,255,0,0.15);
  color:#ffff00;
}
.btn.enhanced:hover {
  box-shadow:0 0 24px rgba(255,255,0,0.35), 0 0 2px rgba(255,255,0,0.9) inset;
}
.btn.enhanced::after {
  content: ' [ENHANCED]';
  font-size: 0.7em;
  opacity: 0.8;
}
.layer{ position:absolute; inset:0; pointer-events:none; z-index:1; }
.light-spill{
  background:radial-gradient(circle at var(--mx) var(--my), rgba(77,227,255,0.18), transparent 40%);
  mix-blend-mode:screen;
}
.mount{
  width:512px; height:512px;
  background:transparent; border:1px solid rgba(77,227,255,0.45);
  box-shadow:0 0 26px rgba(77,227,255,0.25);
  border-radius:12px; position:relative; z-index:2;
  display: flex; align-items: center; justify-content: center;
}

/* Idle State */
.idle-particles {
  position: absolute;
  width: 100%;
  height: 100%;
  background: radial-gradient(ellipse at center, 
      rgba(77,227,255,0.15) 0%, 
      rgba(77,227,255,0.08) 50%, 
      transparent 70%);
  border-radius: 12px;
  animation: pulse-idle 3s ease-in-out infinite;
  display: flex;
  align-items: center;
  justify-content: center;
}

.idle-particles::before {
  content: '';
  width: 60px;
  height: 60px;
  border: 2px solid rgba(77,227,255,0.4);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 2s linear infinite;
}

.idle-particles::after {
  content: 'SELECT ORACLE';
  position: absolute;
  bottom: 25%;
  font-family: var(--title-font);
  color: rgba(77,227,255,0.8);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px rgba(77,227,255,0.5);
  animation: pulse-text 2s ease-in-out infinite;
}

/* Avatar containers for 3 DIFFERENT visual styles */
.avatar-simli {
  position: absolute;
  width: 100%;
  height: 100%;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  overflow: hidden;
}

.avatar-simli.active {
  display: flex;
}

/* Visual differentiation for each avatar */
.avatar-bigfoot {
  filter: sepia(30%) hue-rotate(30deg) saturate(1.3) brightness(0.95);
  border: 1px solid rgba(139,69,19,0.6);
  box-shadow: 0 0 20px rgba(139,69,19,0.3);
}

.avatar-indiana {
  filter: hue-rotate(0deg) saturate(1.1) brightness(1.05) contrast(1.05);
  border: 1px solid rgba(77,227,255,0.6);
  box-shadow: 0 0 20px rgba(77,227,255,0.3);
}

.avatar-vonnegut {
  filter: sepia(15%) hue-rotate(200deg) saturate(0.9) contrast(1.15) brightness(0.98);
  border: 1px solid rgba(255,255,0,0.6);
  box-shadow: 0 0 20px rgba(255,255,0,0.3);
}

/* Enhanced badge */
.enhanced-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: linear-gradient(45deg, #ffff00, #ff8c00);
  color: #000;
  padding: 3px 6px;
  border-radius: 8px;
  font-size: 7px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: none;
  z-index: 5;
}

.avatar-vonnegut .enhanced-badge {
  display: block;
}

/* Loading/Connection states */
.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  z-index: 10;
}

.loading-overlay::after {
  content: 'CONNECTING...';
  font-family: var(--title-font);
  color: var(--cyan);
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 2px;
  text-shadow: 0 0 10px var(--cyan);
  animation: pulse-text 1.5s ease-in-out infinite;
}

/* Status display */
.status-display {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: rgba(0,0,0,0.8);
  border: 1px solid rgba(77,227,255,0.3);
  border-radius: 8px;
  font-size: 12px;
  z-index: 20;
  text-align: center;
  min-width: 200px;
  font-family: var(--ui-font);
}

/* Test panel */
.test-panel {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  background: rgba(0,0,0,0.9);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(77,227,255,0.3);
  z-index: 25;
}

.test-panel input {
  width: 300px;
  padding: 6px 10px;
  background: rgba(77,227,255,0.1);
  border: 1px solid rgba(77,227,255,0.3);
  border-radius: 5px;
  color: var(--cyan);
  font-size: 12px;
  font-family: var(--ui-font);
  margin-right: 8px;
}

.test-panel input::placeholder {
  color: rgba(77,227,255,0.5);
}

.test-panel button {
  padding: 6px 12px;
  background: linear-gradient(135deg, rgba(77,227,255,0.2), rgba(126,107,255,0.2));
  border: 1px solid rgba(77,227,255,0.4);
  border-radius: 5px;
  color: var(--cyan);
  cursor: pointer;
  font-size: 11px;
  font-family: var(--ui-font);
  margin: 0 2px;
}

.test-toggle {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,0,0.2);
  border: 1px solid #ffff00;
  color: #ffff00;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 9px;
  cursor: pointer;
  z-index: 30;
  font-family: var(--ui-font);
}

/* Animations */
@keyframes pulse-idle {
  0%, 100% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.02); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse-text {
  0%, 100% { opacity: 0.6; text-shadow: 0 0 5px currentColor; }
  50% { opacity: 1; text-shadow: 0 0 15px currentColor; }
}
</style>
</head>
<body>
<div class="layer light-spill" id="parallaxLayer"></div>

<!-- Status Display -->
<div class="status-display" id="statusDisplay">
    System: Master Oracle Interface Ready
</div>

<!-- Test Toggle Button -->
<button class="test-toggle" onclick="toggleTestPanel()">
    REMOTE TEST
</button>

<div class="w-full text-center mt-6 select-none">
  <h1 class="text-2xl md:text-4xl tracking-wider">ECHOES OF INDIANA</h1>
  <div class="subtitle text-xs md:text-sm mt-1">LIVE HOLOGRAPHIC CONVERSATIONS POWERED BY RESEARCH</div>
</div>

<main class="w-full h-[70vh] flex items-center justify-center">
  <div class="mount" aria-label="Oracle avatar mount">
    <!-- Idle State -->
    <div class="idle-particles" id="idleParticles"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay"></div>
    
    <!-- Bigfoot Avatar Container -->
    <div class="avatar-simli avatar-bigfoot" id="avatarBigfoot">
      <div class="enhanced-badge">CRYPTID</div>
    </div>
    
    <!-- Indiana Avatar Container -->
    <div class="avatar-simli avatar-indiana" id="avatarIndiana">
      <div class="enhanced-badge">ORACLE</div>
    </div>
    
    <!-- Vonnegut Avatar Container -->
    <div class="avatar-simli avatar-vonnegut" id="avatarVonnegut">
      <div class="enhanced-badge">ENHANCED</div>
    </div>
  </div>
</main>

<footer class="flex gap-6 justify-center pb-10">
  <button class="btn" data-persona="bigfoot" onclick="switchPersona('bigfoot')">Brown County Bigfoot</button>
  <button class="btn" data-persona="indiana" onclick="switchPersona('indiana')">Hoosier Oracle</button>
  <button class="btn enhanced" data-persona="vonnegut" onclick="switchPersona('vonnegut')">Kurt Vonnegut</button>
</footer>

<!-- Remote Test Panel -->
<div class="test-panel" id="testPanel">
    <input type="text" id="testInput" placeholder="Enter test text..." maxlength="200">
    <button onclick="sendTestText()">Send</button>
    <button onclick="toggleTestPanel()">Close</button>
</div>

<script>
console.log('ðŸš€ LOADING MASTER ORACLE KIOSK - Beautiful Design');

// Mouse parallax effect
(function(){
  const light = document.getElementById('parallaxLayer');
  if(!light) return;
  let mx=50, my=50, ticking=false;
  function update(){
    light.style.setProperty('--mx', mx + '%');
    light.style.setProperty('--my', my + '%');
    ticking=false;
  }
  addEventListener('mousemove', e=>{
    mx = (e.clientX / innerWidth) * 100;
    my = (e.clientY / innerHeight) * 100;
    if(!ticking){ requestAnimationFrame(update); ticking=true; }
  }, { passive:true });
})();

// Configuration
const CONFIG = {
    personas: {
        bigfoot: { 
            name: 'Brown County Bigfoot', 
            faceId: '4a857f92-feee-4b70-b973-290baec4d545',
            enhanced: false
        },
        indiana: { 
            name: 'Hoosier Oracle', 
            faceId: '76ed1ae8-720c-45de-918c-cac46984412d',
            enhanced: false
        },
        vonnegut: { 
            name: 'Kurt Vonnegut', 
            faceId: '7bcb45a5-839c-4f1a-b6f9-4ebcdf457264',
            enhanced: true
        }
    },
    currentSession: null,
    useComposeAPI: true
};

const API_BASE = window.location.origin;

// State Management
let currentState = 'IDLE';
let currentPersona = null;
let activeWidget = null;

// DOM Elements
const idleParticles = document.getElementById('idleParticles');
const loadingOverlay = document.getElementById('loadingOverlay');
const statusDisplay = document.getElementById('statusDisplay');
const testPanel = document.getElementById('testPanel');
const testInput = document.getElementById('testInput');

function updateStatus(message) {
    statusDisplay.textContent = `System: ${message}`;
    console.log(`[Master Oracle] ${message}`);
}

function toggleTestPanel() {
    testPanel.style.display = testPanel.style.display === 'none' ? 'block' : 'none';
}

async function sendTestText() {
    const text = testInput.value.trim();
    if (!text) {
        alert('Please enter test text');
        return;
    }
    
    if (!currentPersona) {
        alert('Please select a persona first');
        return;
    }
    
    updateStatus(`Testing ${CONFIG.personas[currentPersona].name}...`);
    
    try {
        if (currentPersona === 'vonnegut') {
            // Use enhanced Vonnegut endpoint
            const response = await fetch(`${API_BASE}/test-vonnegut-text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            
            const result = await response.json();
            if (result.success) {
                updateStatus(`Vonnegut: "${result.vonnegut_response.substring(0, 40)}..."`);
            } else {
                updateStatus(`Error: ${result.error}`);
            }
        } else {
            // Use Compose speak endpoint
            const response = await fetch(`${API_BASE}/simli-compose/speak`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ persona: currentPersona, text: text })
            });
            
            const result = await response.json();
            if (result.success) {
                updateStatus(`${result.message}`);
            } else {
                updateStatus(`Error: ${result.error}`);
            }
        }
        
    } catch (error) {
        console.error('Test error:', error);
        updateStatus(`Connection error: ${error.message}`);
    }
    
    testInput.value = '';
}

async function switchPersona(personaId) {
    if (currentState === 'CONNECTING') return;
    
    console.log(`[Master Oracle] Switching to: ${personaId}`);
    
    // Update button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-persona="${personaId}"]`).classList.add('active');
    
    // End current session if active
    if (currentState === 'LIVE') {
        await endSession();
    }
    
    // Start transition sequence
    currentState = 'CONNECTING';
    currentPersona = personaId;
    
    const persona = CONFIG.personas[personaId];
    updateStatus(`Summoning ${persona.name}...`);
    
    // Hide idle particles and show loading
    idleParticles.style.display = 'none';
    loadingOverlay.style.display = 'flex';
    
    // Simulate transition
    setTimeout(async () => {
        await loadAvatar(personaId);
    }, 2000);
}

async function loadAvatar(personaId) {
    const persona = CONFIG.personas[personaId];
    
    try {
        if (CONFIG.useComposeAPI) {
            // Create Compose session
            const response = await fetch(`${API_BASE}/simli-compose/session?persona=${encodeURIComponent(personaId)}`, {
                method: 'POST'
            });
            
            const sessionData = await response.json();
            
            if (sessionData.token) {
                CONFIG.currentSession = sessionData;
                showAvatar(personaId);
                if (persona.enhanced) {
                    updateStatus(`${persona.name} Active - Enhanced Corpus`);
                } else {
                    updateStatus(`${persona.name} Active - Compose Mode`);
                }
                currentState = 'LIVE';
            } else {
                throw new Error('Failed to create Compose session');
            }
        } else {
            // Use Widget API (fallback)
            await loadSimliWidget(personaId);
        }
        
    } catch (error) {
        console.error('[Master Oracle] Error loading avatar:', error);
        updateStatus(`Connection failed: ${error.message}`);
        returnToIdle();
    }
}

function showAvatar(personaId) {
    // Hide loading
    loadingOverlay.style.display = 'none';
    
    // Hide all avatars
    document.querySelectorAll('.avatar-simli').forEach(avatar => {
        avatar.classList.remove('active');
    });
    
    // Show selected avatar with proper styling
    const avatarElement = document.getElementById(`avatar${personaId.charAt(0).toUpperCase() + personaId.slice(1)}`);
    if (avatarElement) {
        avatarElement.classList.add('active');
        
        // Add placeholder content for now (until Simli widget loads)
        if (!avatarElement.querySelector('.avatar-placeholder')) {
            const placeholder = document.createElement('div');
            placeholder.className = 'avatar-placeholder';
            placeholder.style.cssText = `
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: var(--title-font);
                font-size: 14px;
                color: var(--cyan);
                text-shadow: 0 0 10px currentColor;
                letter-spacing: 1px;
            `;
            placeholder.textContent = `${CONFIG.personas[personaId].name.toUpperCase()} READY`;
            avatarElement.appendChild(placeholder);
        }
    }
    
    console.log(`[Master Oracle] Showing ${personaId} avatar with visual styling`);
}

async function loadSimliWidget(personaId) {
    // Widget implementation (fallback) 
    const persona = CONFIG.personas[personaId];
    showAvatar(personaId);
    updateStatus(`${persona.name} Active - Widget Mode`);
    currentState = 'LIVE';
}

async function endSession() {
    if (currentState !== 'LIVE') return;
    
    currentState = 'ENDING';
    updateStatus('Releasing spirit...');
    
    // Show loading briefly
    loadingOverlay.style.display = 'flex';
    
    // Clean up session
    if (CONFIG.currentSession) {
        CONFIG.currentSession = null;
    }
    
    setTimeout(() => {
        returnToIdle();
    }, 1000);
}

function returnToIdle() {
    currentState = 'IDLE';
    currentPersona = null;
    CONFIG.currentSession = null;
    
    updateStatus('Master Oracle Interface Ready');
    
    // Hide loading
    loadingOverlay.style.display = 'none';
    
    // Show idle particles
    idleParticles.style.display = 'flex';
    
    // Hide all avatars
    document.querySelectorAll('.avatar-simli').forEach(avatar => {
        avatar.classList.remove('active');
    });
    
    // Clear button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// Initialize
window.addEventListener('load', async () => {
    console.log('ðŸš€ Master Oracle Kiosk Initialized - Beautiful Design');
    updateStatus('Master Oracle Interface Ready - Select an Oracle');
    
    // ESC key handler
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (currentState === 'LIVE') {
                endSession();
            }
            testPanel.style.display = 'none';
        }
    });
    
    // Enter key in test input
    testInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendTestText();
        }
    });
});
</script>
</body>
</html>