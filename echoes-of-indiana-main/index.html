<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Indiana</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <div id="click-to-start" class="click-to-start">
        <div class="start-prompt">Touch to Begin</div>
    </div>

    <div id="persona-menu" class="persona-menu">
        <div class="menu-header">ECHOES OF INDIANA</div>
        <div class="persona-list">
            <button class="persona-btn" data-persona="mabel">
                <span class="persona-name">Mabel</span>
                <span class="persona-role">Showers Worker, 1917</span>
            </button>
        </div>
        <button id="btn-dismiss" class="dismiss-btn">Dismiss</button>
    </div>

    <!-- Loading Message -->
    <div id="loading-msg" class="loading-msg hidden">
        <div class="loading-text">Summoning...</div>
    </div>

    <!-- 
        STAGE: All video layers share the SAME head-container positioning
        Layer 2 = Abstract videos (idle loop, transitions)
        Layer 3 = Simli (appears on top when active)
    -->
    <div id="stage">
        <!-- LAYER 2: Background/Transition Videos -->
        <div id="layer-abstract" class="video-layer-container">
            <div class="head-container" id="video-mount">
                <video id="video-idle-loop" class="video-layer" playsinline loop muted></video>
                <video id="video-transition" class="video-layer" playsinline muted></video>
            </div>
        </div>
        
        <!-- LAYER 3: Simli - uses SAME head-container class for identical positioning -->
        <div id="layer-simli" class="video-layer-container">
            <div class="head-container" id="simli-container">
                <div id="simli-mount" class="simli-wrapper"></div>
            </div>
        </div>
    </div>

    <div id="debug-panel" class="debug-panel">
        <div>State: <span id="debug-state">-</span></div>
        <div>Simli: <span id="debug-simli">-</span></div>
    </div>

    <script src="config.js"></script>
    <script src="state-machine.js"></script>
    <script src="simli-integration.js"></script>
    <script src="compositor.js"></script>
    
    <script>
        let isStarted = false;
        
        document.getElementById('click-to-start').addEventListener('click', () => {
            if (isStarted) return;
            isStarted = true;
            document.getElementById('click-to-start').classList.add('hidden');
            Compositor.startIdleLoop();
        });
        
        document.querySelectorAll('.persona-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-persona');
                if (!isStarted) {
                    isStarted = true;
                    document.getElementById('click-to-start').classList.add('hidden');
                    Compositor.startIdleLoop();
                }
                document.getElementById('loading-msg').classList.remove('hidden');
                setTimeout(() => Compositor.invokePersona(id), 100);
            });
        });
        
        // DISMISS - Force cleanup regardless of state
        document.getElementById('btn-dismiss').addEventListener('click', () => {
            console.log('[UI] Dismiss clicked - forcing cleanup');
            document.getElementById('loading-msg').classList.add('hidden');
            Compositor.forceReset();
        });

        document.addEventListener('simli-video-ready', () => {
            document.getElementById('loading-msg').classList.add('hidden');
        });

        document.addEventListener('statechange', (e) => {
            if (e.detail.state === 'idle') {
                document.getElementById('loading-msg').classList.add('hidden');
            }
            document.getElementById('debug-state').textContent = e.detail.state;
        });
    </script>
</body>
</html>
