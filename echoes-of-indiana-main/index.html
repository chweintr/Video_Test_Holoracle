<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of Indiana</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://app.simli.com/simli-widget/index.js" defer></script>
</head>
<body>
    <div id="click-to-start" class="click-to-start">
        <div class="start-prompt">Touch to Begin</div>
    </div>

    <div id="persona-menu" class="persona-menu">
        <div class="menu-header">ECHOES OF INDIANA</div>
        <div class="persona-list">
            <button class="persona-btn" data-persona="mabel">
                <div class="persona-thumbnail">
                    <video class="persona-preview" autoplay loop muted playsinline>
                        <source src="assets/images and ideas/for menu/33622e5c-6107-4da0-9794-8ea784ccdb43.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="persona-info">
                    <span class="persona-name">Mabel</span>
                    <span class="persona-role">Showers Worker, 1917</span>
                </div>
            </button>
        </div>
        <button id="btn-dismiss" class="dismiss-btn">Dismiss</button>
    </div>

    <!-- Loading Message -->
    <div id="loading-msg" class="loading-msg hidden">
        <div class="loading-text">Summoning...</div>
    </div>

    <!-- 
        STAGE: All video layers share the SAME head-container positioning
        Layer 2 = Abstract videos (idle loop, transitions)
        Layer 3 = Simli (appears on top when active)
    -->
    <!-- 
        MASTER STAGE - Everything renders inside this centered box
        All layers MUST conform to this container's bounds
    -->
    <div id="stage">
        <!-- 
            HOLOGRAM MOUNT - The sacred box where all layers live
            This is THE reference point for all positioning
            
            SANDWICH (bottom to top):
            z-index 1: Bottom floaties (future)
            z-index 2: Idle loop (always visible)
            z-index 3: Transition video
            z-index 4: Simli agent
            z-index 5: Top floaties (future)
        -->
        <div id="hologram-mount">
            <!-- Layer 1: Bottom floaties (future) -->
            <!-- <video id="video-floaties-bottom" class="layer layer-1" playsinline loop muted></video> -->
            
            <!-- Layer 2: Idle loop - ALWAYS PLAYING -->
            <video id="video-idle-loop" class="layer layer-2" playsinline loop muted></video>
            
            <!-- Layer 3: Transition video -->
            <video id="video-transition" class="layer layer-3" playsinline muted></video>
            
            <!-- Layer 4: Simli agent -->
            <div id="simli-mount" class="layer layer-4"></div>
            
            <!-- Layer 5: Top floaties (future) -->
            <!-- <video id="video-floaties-top" class="layer layer-5" playsinline loop muted></video> -->
        </div>
    </div>

    <div id="debug-panel" class="debug-panel">
        <div>State: <span id="debug-state">-</span></div>
        <div>Simli: <span id="debug-simli">-</span></div>
    </div>

    <!-- Background Music -->
    <audio id="bg-music" loop preload="auto">
        <source src="assets/Sound/echoes_background_music.m4a" type="audio/mp4">
    </audio>

    <!-- Volume Controls -->
    <div id="volume-controls">
        <button id="volume-toggle" title="Toggle Music">üîä</button>
        <input type="range" id="volume-slider" min="0" max="100" value="35" title="Volume">
    </div>

    <script src="config.js"></script>
    <script src="state-machine.js"></script>
    <script src="simli-integration.js"></script>
    <script src="compositor.js"></script>
    
    <script>
        let isStarted = false;
        
        document.getElementById('click-to-start').addEventListener('click', () => {
            if (isStarted) return;
            isStarted = true;
            document.getElementById('click-to-start').classList.add('hidden');
            Compositor.startIdleLoop();
        });
        
        // MUSIC CONTROLS
        const bgMusic = document.getElementById('bg-music');
        const volumeToggle = document.getElementById('volume-toggle');
        const volumeSlider = document.getElementById('volume-slider');
        let musicStarted = false;
        
        bgMusic.volume = 0.35; // Start at 35%
        
        volumeToggle.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play();
                volumeToggle.textContent = 'üîä';
            } else {
                bgMusic.pause();
                volumeToggle.textContent = 'üîá';
            }
        });
        
        volumeSlider.addEventListener('input', (e) => {
            bgMusic.volume = e.target.value / 100;
            volumeToggle.textContent = bgMusic.volume > 0 ? 'üîä' : 'üîá';
        });

        document.querySelectorAll('.persona-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-persona');
                if (!isStarted) {
                    isStarted = true;
                    document.getElementById('click-to-start').classList.add('hidden');
                    Compositor.startIdleLoop();
                }
                
                // Start background music on first persona click
                if (!musicStarted) {
                    musicStarted = true;
                    bgMusic.play().catch(e => console.log('Music autoplay blocked:', e));
                }
                
                // Mark this button as active, remove from others
                document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('loading-msg').classList.remove('hidden');
                setTimeout(() => Compositor.invokePersona(id), 100);
            });
        });
        
        // DISMISS - Force cleanup regardless of state
        document.getElementById('btn-dismiss').addEventListener('click', () => {
            console.log('[UI] Dismiss clicked - forcing cleanup');
            document.getElementById('loading-msg').classList.add('hidden');
            
            // Remove active state from all persona buttons
            document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
            
            Compositor.forceReset();
        });

        document.addEventListener('simli-video-ready', () => {
            document.getElementById('loading-msg').classList.add('hidden');
        });

        document.addEventListener('statechange', (e) => {
            if (e.detail.state === 'idle') {
                document.getElementById('loading-msg').classList.add('hidden');
                // Remove active state when returning to idle
                document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
            }
            document.getElementById('debug-state').textContent = e.detail.state;
        });

        // DEBUG MODE: Add ?debug=borders to URL to see layer boundaries
        // Red = hologram-mount, Blue = idle, Green = transition, Yellow = simli, Magenta = widget
        if (new URLSearchParams(window.location.search).get('debug') === 'borders') {
            document.body.classList.add('debug-borders');
            console.log('[DEBUG] Border mode enabled - showing layer boundaries');
        }
        
        // CALIBRATE MODE: Add ?calibrate to URL for interactive positioning
        if (new URLSearchParams(window.location.search).get('calibrate') !== null) {
            // Current values (match styles.css simli-widget transform)
            let scale = 1.6;
            let moveX = 20;
            let moveY = 6;
            
            // Create control panel
            const panel = document.createElement('div');
            panel.id = 'calibrate-panel';
            panel.innerHTML = `
                <div class="cal-title">SIMLI CALIBRATION</div>
                <div class="cal-row">
                    <span>Scale:</span>
                    <button onclick="calAdjust('scale', -0.1)">‚àí</button>
                    <span id="cal-scale">1.6</span>
                    <button onclick="calAdjust('scale', 0.1)">+</button>
                </div>
                <div class="cal-row">
                    <span>Move X:</span>
                    <button onclick="calAdjust('x', -2)">‚Üê</button>
                    <span id="cal-x">20%</span>
                    <button onclick="calAdjust('x', 2)">‚Üí</button>
                </div>
                <div class="cal-row">
                    <span>Move Y:</span>
                    <button onclick="calAdjust('y', -2)">‚Üë</button>
                    <span id="cal-y">6%</span>
                    <button onclick="calAdjust('y', 2)">‚Üì</button>
                </div>
                <div class="cal-css" id="cal-css">transform: translateX(20%) translateY(6%) scale(1.6)</div>
            `;
            document.body.appendChild(panel);
            
            // Adjustment function
            window.calAdjust = function(type, delta) {
                if (type === 'scale') scale = Math.round((scale + delta) * 10) / 10;
                if (type === 'x') moveX += delta;
                if (type === 'y') moveY += delta;
                
                document.getElementById('cal-scale').textContent = scale.toFixed(1);
                document.getElementById('cal-x').textContent = moveX + '%';
                document.getElementById('cal-y').textContent = moveY + '%';
                
                const css = `transform: translateX(${moveX}%) translateY(${moveY}%) scale(${scale})`;
                document.getElementById('cal-css').textContent = css;
                
                // Apply to Simli widget
                const widget = document.querySelector('simli-widget');
                if (widget) {
                    widget.style.cssText = `
                        position: absolute !important;
                        top: 0 !important; left: 0 !important;
                        width: 100% !important; height: 100% !important;
                        transform: translateX(${moveX}%) translateY(${moveY}%) scale(${scale}) !important;
                        transform-origin: center center !important;
                        background: #000 !important;
                        mix-blend-mode: screen !important;
                    `;
                }
            };
            
            console.log('[CALIBRATE] Interactive controls enabled');
        }
    </script>
</body>
</html>
